<html>
  <head>
    <title>Starherd</title>
    <style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: #222;
}
    </style>
  </head>
  <body>
    <canvas id="hr"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
const canvas = document.getElementById('hr')

// Math
const random_range = (a, b) => a + (b - a) * Math.random()
const in_range = (a, x, b) => (a <= x) && (x <= b)
const log10 = (x) => Math.log(x)/Math.log(10)
const int_range = (n) => Array(n).fill(0).map((_, i) => i)

// Constants
const PI = Math.PI
const STEFAN = 5.670374419e-8
const L_sun = 3.86e+26 // watts
const R_sun = 6.9634e+8 // meters

// Conversions
const abs_mag_to_sol_lum = M => 
  Math.pow(100, -M/5)
  
const bv_to_temp = i => 
  4600 * (1/(0.92*i + 1.7) + 1/(0.92*i + 0.62))
  
const sol_radius_and_sol_lum_to_temp = (R, L) => 
  ( L*L_sun / ((4*PI*R*R*R_sun*R_sun) * STEFAN) ) ** (1/4)

// Probability density function of stars' initial masses
const initial_mass_function = M => (
  in_range(0.08, M, 0.50) ? 0.035 * Math.pow(M, -1.3)
  : in_range (0.50, M, 1.00) ? 0.019 * Math.pow(M, -2.2)
  : in_range (1.00, M, 100) ? 0.019 * Math.pow(M, -2.7)
  : 0
)

// Zeta function of metallicity Z
const phases = {
  MS_convective: {
    name: "Main Sequence"
  }
}

const polynomial = coefficients => x => 
  coefficients.reduce((sum, coefficient, degree) => sum + coefficient * (x**degree), 0)

const L_ZAMS = (M, ζ) => {
  const coefficients = [
    [ 0.3970417, -0.32913574, 0.34776688, 0.37470851, 0.09011915 ],
    [ 8.527626, -24.41225973, 56.43597107, 37.06152575, 5.4562406 ],
    [ 0.00025546, -0.00123461, -0.00023246, 0.00045519, 0.00016176 ],
    [ 5.432889, -8.62157806, 13.44202049, 14.51584135, 3.39793084 ],
    [ 5.563579, -10.32345224, 19.4432298, 18.97361347, 4.16903097 ],
    [ 0.7886606, -2.90870942, 6.54713531, 4.05606657, 0.53287322 ],
    [ 0.00586685, -0.01704237, 0.03872348, 0.02570041, 0.00383376 ]
  ]
  const p = n => polynomial(coefficients[n])(ζ)
  const [ _α, _β, _γ, _δ, _ε, _ζ, _η ] = int_range(7).map(p)
  const L = ( _α*(M**5.5) + _β*(M**11)) / ( _γ*(M**3) + _δ*(M**5) + _ε*(M**7) + _ζ*(M**8) + _η*(M**9.5) )
  return L
}


const R_ZAMS = (M, ζ) => {
  const coefficients = [
    [ 1.715359, 0.62246212, -0.92557761, -1.16996966, -0.30631491 ], 
    [ 6.597788, -0.42450044, -12.13339427, -10.73509484, -2.51487077 ],
    [ 10.08855, -7.11727086, -31.67119479, -24.24848322, -5.33608972 ],
    [ 1.012495, 0.3269969, -0.00923418, -0.03876858, -0.0041275 ],
    [ 0.07490166, 0.02410413, 0.07233664, 0.03040467, 0.00197741 ],
    [ 0.01077422, 0, 0, 0, 0 ],
    [ 3.082234, 0.9447205, -2.15200882, -2.49219496, -0.63848738 ],
    [ 17.84778, -7.4534569, -48.96066856, -40.05386135, -9.09331816 ],
    [ 0.00022582, -0.00186899, 0.00388783, 0.00142402, -0.00007671 ],
  ]
  const p = n => polynomial(coefficients[n])(ζ)
  const [ _θ, _ι, _κ, _λ, _μ, _ν, _ξ, _ο, _π ] = int_range(9).map(p) 
  const R = ( _θ*(M**2.5) + _ι*(M**6.5) + _κ*(M**11) + _λ*(M**19.5) ) / (  _ν + _ξ*(M**2) + _ο*(M**8.5) + (M**18.5) + _π*(M**19.5) )
  return R
}
  
const star = (M, Z, t) => {
  const ζ = log10(Z)

  
}

  console.log(L_ZAMS(1,0.2))

let min_bv = 0, max_bv = +3
let min_temp = bv_to_temp(min_bv), max_temp = bv_to_temp(max_bv)

let min_mag = +10, max_mag = -10
let min_sol_lum = abs_mag_to_sol_lum(min_mag), max_sol_lum = abs_mag_to_sol_lum(max_mag)

let min_mass = 0.08, max_mass = 100

const display = true

const bubble_config = {
  count: 7,
  rmin: 5,
  rmax: 15,
  min: 0,
  max: 100
}


const stars = {
  test: { x: 0, y: 0, r: 10 }
}

const masses = {}
for(let i = 0; i < 1000; i++){
  const mass = random_range(min_mass, max_mass)
  
  // Reject unlikely masses
  const test_mass = random_range(min_mass, max_mass)
  if(initial_mass_function(mass) < initial_mass_function(test_mass)) continue
  
  const Z = 0.02
  const ζ = log10(Z)
  const R = R_ZAMS(mass, ζ)
  const L = L_ZAMS(mass, ζ)
  stars[i] = {
    x: sol_radius_and_sol_lum_to_temp(R, L),
    y: L,
    r: mass
  }
}

Chart.defaults.color = '#ccc'
Chart.defaults.borderColor = '#444'
Chart.defaults.maintainAspectRatio = false

new Chart(canvas, {
  type: 'bubble',
  data: {
    datasets: [{
      label: 'Stars',
      data: Object.values(stars),
      borderWidth: 1
    }]
  },
  options: {
    scales: {
      x: {
        type: 'linear',
        title: { display, text: 'Surface temperature (Kelvins)' },
        position: 'top',
        min: min_temp, max: max_temp,
        reverse: true,
        grid: { drawOnChartArea: false },
      },
      x1: {
        type: 'linear',
        title: { display, text: 'Blue light versus visible light (B−V index)' },
        position: 'bottom',
        min: min_bv, max: max_bv,
        grid: { drawOnChartArea: true },
      },
      y: {
        type: 'logarithmic',
        title: { display, text: 'Luminosity in Suns (L⊙)' },
        display: true,
        position: 'right',
        min: min_sol_lum, max: max_sol_lum,
        grid: { drawOnChartArea: false },
      },
      y1: {
        type: 'linear',
        position: 'left',
        title: { display, text: 'Hipparchus’s scale (Absolute magnitude)' },
        min: max_mag, max: min_mag,
        reverse: true,
        grid: { drawOnChartArea: true },
      },
    }
  }
})
    </script>
  </body>
</html>
